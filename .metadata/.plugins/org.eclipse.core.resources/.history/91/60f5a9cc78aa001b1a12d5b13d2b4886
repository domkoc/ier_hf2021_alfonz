import jason.asSyntax.*;
import jason.environment.Environment;
import jason.environment.grid.Location;
import java.util.logging.Logger;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.util.ArrayList;

public class Building extends Environment{

    public static final Term	clean = Literal.parseLiteral("clean(x1, y1)");
    public static final Term	refuel = Literal.parseLiteral("refuel(minion)");
    public static final Term	restock = Literal.parseLiteral("restock(minion)");
    
    static Logger logger = Logger.getLogger(Building.class.getName());

    BuildingModel model;
    BuildingView  view;
    private Location vacuum_BPrevious;
    private Location vacuum_APrevious;
    private Location stuartPrevious;
    ArrayList<Location> garbages = new ArrayList<Location>();
    ArrayList<Boolean> garbageValidity = new ArrayList<Boolean>();

    int vacuum_BCharge = 50;
    int vacuum_ACharge = 50;
    int stuartCharge = 50;
    int vacuum_BSupplies = 30;
    int vacuum_ASupplies = 30;
    int stuartSupplies = 30;

    int vacuum_BOldCharge;
    int vacuum_AOldCharge;
    int stuartOldCharge;
    int vacuum_BOldSupplies;
    int vacuum_AOldSupplies;
    int stuartOldSupplies;
   

    @Override
    public void init(String[] args) {
        model = new BuildingModel();

        Location vacuum_BLoc = model.getAgPos(0);
        Location vacuum_ALoc = model.getAgPos(1);
        Location stuartLoc = model.getAgPos(2);
        vacuum_BPrevious = vacuum_BLoc;
        vacuum_APrevious = vacuum_ALoc;
        stuartPrevious = stuartLoc;    

        Literal self1 = Literal.parseLiteral("isSelf(vacuum_B)");
        Literal self2 = Literal.parseLiteral("isSelf(vacuum_A)");
        Literal self3 = Literal.parseLiteral("isSelf(stuart)");

        addPercept("vacuum_B", self1);
        addPercept("vacuum_A", self2);
        addPercept("stuart", self3);

        Literal limit1 = Literal.parseLiteral("needs_charge(25, vacuum_B)");
        Literal limit2 = Literal.parseLiteral("needs_charge(25, vacuum_A)");
        Literal limit3 = Literal.parseLiteral("needs_charge(25, stuart)");
        addPercept("vacuum_B", limit1);
        addPercept("vacuum_A", limit2);
        addPercept("stuart", limit3);

        Literal limit4 = Literal.parseLiteral("needs_space(15, vacuum_B)");
        Literal limit5 = Literal.parseLiteral("needs_space(15, vacuum_A)");
        Literal limit6 = Literal.parseLiteral("needs_space(15, stuart)");
        addPercept("vacuum_B", limit4);
        addPercept("vacuum_A", limit5);
        addPercept("stuart", limit6);

        Location garbage = new Location(2,4);
        garbages.add(garbage);
        garbageValidity.add(true);

        Literal free1 = Literal.parseLiteral("free(vacuum_B)");
        Literal free2 = Literal.parseLiteral("free(vacuum_A)");
        Literal free3 = Literal.parseLiteral("free(stuart)");

        addPercept("dirtsensor", free1);
        addPercept("dirtsensor", free2);
        addPercept("dirtsensor", free3);

        view  = new BuildingView(model);
		view.addClickListener(this);
        
        model.setView(view);
        Literal dirt_generated = Literal.parseLiteral("dirt_generated(garbage1)");
        Literal garbage_place = Literal.parseLiteral("pos(garbage1, 2, 4)");
        addPercept("dirtsensor", dirt_generated);
        addPercept(garbage_place);
        updatePercepts();
    }
    
    @Override
    public boolean executeAction(String ag, Structure action) {
        logger.info(ag+" doing: "+ action);
        try {
        	if (action.getFunctor().equals("moveTowards")) {
                int x = (int)((NumberTerm)action.getTerm(0)).solve();
                int y = (int)((NumberTerm)action.getTerm(1)).solve();
                model.moveTowards(ag,x,y);
                int agent = 0;
                if(ag.equals("vacuum_A"))
                    agent = 1;
                if(ag.equals("stuart"))
                    agent = 2;
                Location loc = model.getAgPos(agent);

                int fuelCost = model.findPathAndDistanceTo(loc.x, loc.y, x, y).get(2);
                if(ag.equals("vacuum_B"))
                    vacuum_BCharge -= fuelCost;
                if(ag.equals("vacuum_A"))
                    vacuum_ACharge -= fuelCost;
                if(ag.equals("stuart"))
                    stuartCharge -= fuelCost;
                
            } else if (action.getFunctor().equals("clean")) {
            	int x = (int)((NumberTerm)action.getTerm(0)).solve();
                int y = (int)((NumberTerm)action.getTerm(1)).solve();
                model.clean(ag,x,y);
                garbageValidity.set(garbages.indexOf(new Location(x, y)), false);
                if(ag.equals("vacuum_B"))
                    vacuum_BSupplies -= 5;
                if(ag.equals("vacuum_A"))
                    vacuum_ASupplies -= 5;
                if(ag.equals("stuart"))
                    stuartSupplies -= 5;
                
            } else if (action.getFunctor().equals("set_resource_limits")) {
            	int x = (int)((NumberTerm)action.getTerm(1)).solve();
                int y = (int)((NumberTerm)action.getTerm(2)).solve();
                int fuel;
                if(ag.equals("vacuum_B")){
                    fuel = vacuum_BCharge;
                    Literal allowance = Literal.parseLiteral("is_allowed_to_clean(vacuum_B)");
                    if(model.adjustResourceLimits(ag,x,y, fuel)){
                        addPercept("vacuum_A", allowance);
                    }
                    else{
                        removePercept("vacuum_B", allowance);
                    }
                }
                if(ag.equals("vacuum_A")){
                    fuel = vacuum_ACharge;
                    Literal allowance = Literal.parseLiteral("is_allowed_to_clean(vacuum_A)");
                    if(model.adjustResourceLimits(ag,x,y, fuel)){
                        addPercept("vacuum_A", allowance);
                    }
                    else{
                        removePercept("vacuum_A", allowance);
                    }
                }
                if(ag.equals("stuart")){
                    fuel = stuartCharge;
                    Literal allowance = Literal.parseLiteral("is_allowed_to_clean(stuart)");
                    if(model.adjustResourceLimits(ag,x,y, fuel)){
                        addPercept("stuart", allowance);
                    }
                    else{
                        removePercept("stuart", allowance);
                    }
                }
                
            } else if (action.getFunctor().equals("refuel")) {
                model.refuel(ag);
                System.out.println(vacuum_BCharge);
                if(ag.equals("vacuum_B"))
                    vacuum_BCharge = 50;
                if(ag.equals("vacuum_A"))
                    vacuum_ACharge = 50;
                if(ag.equals("stuart"))
                    stuartCharge = 50;
                
            } else if (action.getFunctor().equals("restock")) {
                model.restock(ag);
                System.out.println("vacuum_BSupplies " + vacuum_BSupplies);
                if(ag.equals("vacuum_B"))
                    vacuum_BSupplies = 25;
                if(ag.equals("vacuum_A"))
                    vacuum_ASupplies = 25;
                if(ag.equals("stuart"))
                    stuartSupplies = 25;
                
            } else if(action.getFunctor().equals("task_cleaning")){
                String minion = action.getTerm(0).toString();
                String position = action.getTerm(1).toString();
                Literal command = Literal.parseLiteral("told_to_vacuum(" + minion + ", " + position + ")");
                Literal busy = Literal.parseLiteral("free(" + minion + ")");
                Literal cleaned = Literal.parseLiteral("dirt_generated(" + position + ")");
                removePercept("dirtsensor", cleaned);
                removePercept("dirtsensor", busy);
                addPercept(minion, command);
            }
            else if(action.getFunctor().equals("done")){
                Literal free = Literal.parseLiteral("free(" + action.getTerm(0).toString() + ")");
                addPercept("dirtsensor", free);
            }
            else {
                return false;
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        updatePercepts();

        try {
            Thread.sleep(200);
        } catch (Exception e) {}
        informAgsEnvironmentChanged();
        return true;
    }
    
    /** creates the agents' perception based on the BuildingModel */
    void updatePercepts() {
        
        Literal oldPos1 = Literal.parseLiteral("pos(vacuum_B," + vacuum_BPrevious.x + ", " + vacuum_BPrevious.y + ")");
        Literal oldPos2 = Literal.parseLiteral("pos(vacuum_A," + vacuum_APrevious.x + ", " + vacuum_APrevious.y + ")");
        Literal oldPos3 = Literal.parseLiteral("pos(stuart," + stuartPrevious.x + ", " + stuartPrevious.y + ")");
        removePercept("vacuum_B", oldPos1);
        removePercept("vacuum_A", oldPos2);
        removePercept("stuart", oldPos3);

        Literal oldCharge1 = Literal.parseLiteral("has_charge(" + vacuum_BOldCharge + ", vacuum_B)");
        Literal oldCharge2 = Literal.parseLiteral("has_charge(" + vacuum_AOldCharge + ", vacuum_A)");
        Literal oldCharge3 = Literal.parseLiteral("has_charge(" + stuartOldCharge + ", stuart)");
        removePercept("vacuum_B", oldCharge1);
        removePercept("vacuum_A", oldCharge2);
        removePercept("stuart", oldCharge3);

        vacuum_BOldCharge = vacuum_BCharge;
        vacuum_AOldCharge = vacuum_ACharge;
        stuartOldCharge = stuartCharge;

        Literal newCharge1 = Literal.parseLiteral("has_charge(" + vacuum_BCharge + ", vacuum_B)");
        Literal newCharge2 = Literal.parseLiteral("has_charge(" + vacuum_ACharge + ", vacuum_A)");
        Literal newCharge3 = Literal.parseLiteral("has_charge(" + stuartOldCharge + ", stuart)");
        addPercept("vacuum_B", newCharge1);
        addPercept("vacuum_A", newCharge2);
        addPercept("stuart", newCharge3);



        Literal oldSpace1 = Literal.parseLiteral("has_space(" + vacuum_BOldSupplies + ", vacuum_B)");
        Literal oldSpace2 = Literal.parseLiteral("has_space(" + vacuum_AOldSupplies + ", vacuum_A)");
        Literal oldSpace3 = Literal.parseLiteral("has_space(" + stuartOldSupplies + ", stuart)");
        removePercept("vacuum_B", oldSpace1);
        removePercept("vacuum_A", oldSpace2);
        removePercept("stuart", oldSpace3);

        vacuum_BOldSupplies = vacuum_BSupplies;
        vacuum_AOldSupplies = vacuum_ASupplies;
        stuartOldSupplies = stuartSupplies;

        Literal newSupplies1 = Literal.parseLiteral("has_space(" + vacuum_BOldSupplies + ", vacuum_B)");
        Literal newSupplies2 = Literal.parseLiteral("has_space(" + vacuum_AOldSupplies + ", vacuum_A)");
        Literal newSupplies3 = Literal.parseLiteral("has_space(" + stuartOldSupplies + ", stuart)");
        addPercept("vacuum_B", newSupplies1);
        addPercept("vacuum_A", newSupplies2);
        addPercept("stuart", newSupplies3);




        Literal garbage1 = Literal.parseLiteral("garbage(vacuum_B)");
        Literal garbage2 = Literal.parseLiteral("garbage(vacuum_A)");
        Literal garbage3 = Literal.parseLiteral("garbage(stuart)");

        Location vacuum_BLoc = model.getAgPos(0);
        Location vacuum_ALoc = model.getAgPos(1);
        Location stuartLoc = model.getAgPos(2);

        if(garbages.contains(vacuum_BLoc) && !garbageValidity.get(garbages.indexOf(vacuum_BLoc))){
            removePercept("vacuum_B", garbage1);
        }
        if(garbages.contains(vacuum_ALoc) && !garbageValidity.get(garbages.indexOf(vacuum_ALoc))){
            removePercept("vacuum_A", garbage2);
        }
        if(garbages.contains(stuartLoc) && !garbageValidity.get(garbages.indexOf(stuartLoc))){
            removePercept("stuart", garbage3);
        }

        if(garbages.contains(vacuum_BLoc) && garbageValidity.get(garbages.indexOf(vacuum_BLoc))){
            Literal warning = Literal.parseLiteral("garbage(vacuum_B)");
            addPercept("vacuum_B", warning);

            Literal cleaning = Literal.parseLiteral("is_allowed_to_clean(vacuum_B)");
            addPercept("vacuum_B", cleaning);
        }
        if(garbages.contains(vacuum_ALoc) && garbageValidity.get(garbages.indexOf(vacuum_ALoc))){
            Literal warning = Literal.parseLiteral("garbage(vacuum_A)");
            addPercept("vacuum_A", warning);

            Literal cleaning = Literal.parseLiteral("is_allowed_to_clean(vacuum_A)");
            addPercept("vacuum_A", cleaning);
        }
        if(garbages.contains(stuartLoc) && garbageValidity.get(garbages.indexOf(stuartLoc))){
            Literal warning = Literal.parseLiteral("garbage(stuart)");
            addPercept("stuart", warning);

            Literal cleaning = Literal.parseLiteral("is_allowed_to_clean(stuart)");
            addPercept("stuart", cleaning);
        }


        vacuum_BPrevious = vacuum_BLoc;
        vacuum_APrevious = vacuum_ALoc;
        stuartPrevious = stuartLoc;    
        
        Literal pos1 = Literal.parseLiteral("pos(vacuum_B," + vacuum_BLoc.x + "," + vacuum_BLoc.y + ")");
        Literal pos2 = Literal.parseLiteral("pos(vacuum_A," + vacuum_ALoc.x + "," + vacuum_ALoc.y + ")");
        Literal pos3 = Literal.parseLiteral("pos(stuart," + stuartLoc.x + "," + stuartLoc.y + ")");

        addPercept("vacuum_B",pos1);
        addPercept("vacuum_A",pos2);
        addPercept("stuart",pos3);

        model.setAgPos(0, vacuum_BLoc);
        model.setAgPos(1, vacuum_ALoc);
        model.setAgPos(2, stuartLoc);

        informAgsEnvironmentChanged();

    }

    void addGarbage(int x, int y){
        garbages.add(new Location(x, y));
        garbageValidity.add(true);
        model.addGarbage(x, y);

        Literal dirt_generated = Literal.parseLiteral("dirt_generated(garbage" + garbages.size() +")");
        Literal garbage_place = Literal.parseLiteral("pos(garbage" + garbages.size() + ", " + x + ", " + y + ")");
        addPercept("dirtsensor", dirt_generated);
        addPercept(garbage_place);
    }
}